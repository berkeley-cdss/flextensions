files:
  "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json":
    mode: "000644"
    owner: root
    group: root
    content: |
      {
        "agent": {
          "metrics_collection_interval": 60,
          "run_as_user": "root"
        },
        "metrics": {
          "namespace": "CWAgent",
          "append_dimensions": {
            "AutoScalingGroupName": "${aws:AutoScalingGroupName}",
            "ImageId": "${aws:ImageId}",
            "InstanceId": "${aws:InstanceId}",
            "InstanceType": "${aws:InstanceType}"
          },
          "aggregation_dimensions": [
            ["InstanceId"],
            []
          ],
          "metrics_collected": {
            "cpu": {
              "measurement": [
                "cpu_usage_idle",
                "cpu_usage_system",
                "cpu_usage_user",
                "cpu_usage_iowait"
              ],
              "totalcpu": true,
              "resources": [
                "*"
              ],
              "metrics_collection_interval": 60
            },
            "mem": {
              "measurement": [
                "mem_used_percent",
                "mem_available"
              ],
              "metrics_collection_interval": 120
            },
            "disk": {
              "measurement": [
                "disk_used_percent",
                "disk_used",
                "disk_free",
                "disk_total",
                "inodes_free",
                "inodes_used"
              ],
              "resources": [
                "/",
                "/data"
              ],
              "drop_device": true,
              "metrics_collection_interval": 120
            },
            "diskio": {
              "measurement": [
                "write_bytes",
                "read_bytes",
                "writes",
                "reads"
              ],
              "resources": [
                "nvme[0-9]n1",
                "xvd*",
                "sd*"
              ],
              "metrics_collection_interval": 180
            },
            "net": {
              "measurement": [
                "bytes_sent",
                "bytes_recv",
                "packets_sent",
                "packets_recv",
                "err_in",
                "err_out"
              ],
              "resources": [
                "eth0",
                "ens*"
              ],
              "metrics_collection_interval": 180
            },
            "netstat": {
              "measurement": [
                "tcp_established",
                "tcp_syn_sent",
                "tcp_time_wait"
              ],
              "metrics_collection_interval": 300
            },
            "processes": {
              "measurement": [
                "running",
                "blocked",
                "sleeping",
                "zombies"
              ],
              "metrics_collection_interval": 300
            }
          }
        }
      }

container_commands:
  01_apply_cwa_config:
    command: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s"
